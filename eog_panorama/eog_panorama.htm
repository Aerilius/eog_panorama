<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!-- Fix page scale -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="photo-sphere-viewer/photo-sphere-viewer.css">

  <style>
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }
    #photosphere {
      width: 100%;
      height: 100%;
    }
  </style>

<script src="three.js/three.js"></script>
<script src="D.js/lib/D.js"></script>
<script src="uevent/uevent.js"></script>
<script src="doT/doT.js"></script>
<script src="photo-sphere-viewer/photo-sphere-viewer.js"></script>
<script type="text/javascript">

/* Issue: Pinch gesture also triggers page zoom in the WebView.
 * Pinch-to-zoom is handled by the canvas and should not bubble up. 
 * Workaround: Disable touch events on the document root.
 */
window.addEventListener('touchstart', function(event) { event.preventDefault(); });


function callPython(message, data) {
    window.location.href = 'eogp://'+message+'/'+data;
}


var PSV;
document.addEventListener("DOMContentLoaded", function(event) {
    
    
    // Tell python when the document finished loading.
    // While instantiation of WebView is synchronous, loading of html is asynchronous.
    // In order to interact from python with the html/javascript, we need to await the document ready event.
    // Note: Webkit returns incorrect viewport values (window.innerWidth=0 etc.) still ca. 1s after onload.
    callPython('document_ready');
    
    
    // Initialize the panorama viewer.
    PSV = new PhotoSphereViewer({
        container: 'photosphere',
        
        // Disable autoload and UI, since we control it manually.
        autoload: false,
        loading_img: false,
        navbar: false,
        caption: false, // (would make navbar show up)
        
        // Avoid XMLHttpRequest which fails locally, we provide the XMP data from eog. 
        // Also there is a mysterious script error when using true.
        usexmpdata: false,
        
        // Rendering
        default_fov: 75,
        // Issue: default min_fov 30 limited zooming too much, decrease it.
        min_fov: 5,
        max_fov: 120,
        fisheye: false,
        // Note: Fallback without webgl requires three.js/CanvasRenderer.js, three.js/Projector.js
        webgl: true,
        
        // Animation
        time_anim: false,
        anim_speed: '0rpm',
        
        // Input
        mousewheel: true,
        mousemove: true,
        move_speed: 1.1,
        keyboard: true,
        gyroscope: true
    });
    
    
    // Simple API to control the panorama from Python
    PSV.show_panorama = function(uri, pano_data) {
        var self = this;
        
        // Set up image size and crop area.
        self.config.pano_data = pano_data;
        
        // Set up zoom level.
        var zoom_level = get_zoom_level(pano_data, self.config.min_fov, self.config.max_fov);
        
        // Set up orientation.
        var position = get_position(pano_data);
        var offset_position = offset_position_by_fraction(position, 1.0/50, 1.0/100);
        
        // Load the new image file, apply the zoom, then animate to position as hint that it is 360Â°.
        return self.setPanorama(uri, offset_position, false)
        .then(function() {
            self.zoom(zoom_level);
            callPython('show_panorama_completed');
        }, function(error) {
            callPython('error', encodeURIComponent(error.name + ': ' + error.message + '\n' + error.stack));
        }).then(function() {
            self.animate(position, 3000);
        });
    };
    
    
    function get_zoom_level(pano_data, min_fov, max_fov) {
        var initial_fov;
        if (pano_data.initial_h_fov && pano_data.initial_h_fov != 0) {
            initial_fov = Math.max(min_fov, Math.min(pano_data.initial_h_fov, max_fov));
        } else {
            // Match the initial zoom level to the cropped size.
            //var h_fov = 360 * pano_data.cropped_width / pano_data.full_width;
            var v_fov = 180 * pano_data.cropped_height / pano_data.full_height;
            initial_fov = v_fov;
        }
        // from photo-sphere-viewer.js:212
        return 100 - 100 * (initial_fov - min_fov) / (max_fov - min_fov);
    }
    
    
    function get_position(pano_data) {
        if (pano_data.initial_heading && pano_data.initial_pitch) {
            return {
                latitude:  pano_data.initial_heading,
                longitude: pano_data.initial_pitch
            };
        } else {
            // Fallback to the center of the image.
            return {
                x: pano_data.cropped_width / 2,
                y: pano_data.cropped_height / 2
            };
        }
    }
    
    
    function offset_position_by_fraction(position, dx, dy) {
        var result = {};
        if (position.latitude)  result.latitude  = position.latitude * (1 + dx);
        if (position.longitude) result.longitude = position.longitude * (1 + dy);
        if (position.x) result.x = position.x * (1 + dx);
        if (position.y) result.y = position.y * (1 + dy);
        return result;
    }
});


// DEBUG helpers:


console.log = function(message) {
    callPython('log', message);
}


console.error = function(message) {
    callPython('error', message);
}


window.onerror = function (errorMsg, url, lineNumber, column, errorObj) {
    if (errorObj) {
        callPython('error', encodeURIComponent(error.name + ': ' + error.message + '\n' + error.stack));
    } else {
        callPython('error', encodeURIComponent(errorMsg + ': ' + url + ':' + lineNumber + ':' + column));
    }
    return true;
}


function test_show_panorama() {
    var data_uri = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/2wBDACAWGBwYFCAcGhwkIiAmMFA0MCwsMGJGSjpQdGZ6eHJmcG6AkLicgIiuim5woNqirr7EztDOfJri8uDI8LjKzsb/2wBDASIkJDAqMF40NF7GhHCExsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsb/wgARCAAgAEADAREAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAECAwT/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAXrE2CIpbzQRjnWR37zIShUoc8qJsSIoa1LQwszNJWIk/8QAHBAAAgIDAQEAAAAAAAAAAAAAAAECERASIQMi/9oACAEBAAEFAs9zVmpOSkRVSpFI4cFOA/SBQ9UORubCtlGhRw+a1gKMViij/8QAGBEAAgMAAAAAAAAAAAAAAAAAETAAASD/2gAIAQMBAT8BUIN27//EABgRAAIDAAAAAAAAAAAAAAAAABEwAAEg/9oACAECAQE/AVGHdO//xAAcEAABBAMBAAAAAAAAAAAAAAAAECAhMQERUTD/2gAIAQEABj8CI8Mcfw1ZCy+ls//EAB8QAAMAAgMBAAMAAAAAAAAAAAABESExQVFhgXGh4f/aAAgBAQABPyFxLOCp7UyUJsuNZK4FChJd8lE+W6PtGKgq5bIt/o4zvwT+DAZPs0R5T0oskuj0S3G/6eBLbs+B6ImJva+mSVesaTY0eD8h/9oADAMBAAIAAwAAABA189v8WVJWJerY19L/xAAZEQADAQEBAAAAAAAAAAAAAAAAAREQIUH/2gAIAQMBAT8QHUUomXYNczIkJEJseHSCQto2KekRw5n/xAAZEQADAQEBAAAAAAAAAAAAAAAAAREQIUH/2gAIAQIBAT8QommQg0TWxPuKGxspchXpEUoy6hlZTpT/xAAfEAEAAgICAwEBAAAAAAAAAAABABEhMUFRYXGBkeH/2gAIAQEAAT8QFxYbWCUCnUU6WeaKKSACAh4j5EogKGzhBUDRYiw7RBhzENNfjAigDeGCCs7LYlDJ6QTF5N1axpSvTb49wXQFIUPPuWcwrRPofMCataTh1C+xrThgbFXmWMPLOo7VY4itPyh8EuEX+RI7+wuwVBjgzq7n/9k=';
    var pano_data = {full_width: 64, full_height: 32, cropped_width: 64, cropped_height: 32, cropped_x: 0, cropped_y: 0};
    PSV.show_panorama(data_uri, pano_data);
}
</script>

</head>
<body>

<div id="photosphere"></div>

</body>
</html>
